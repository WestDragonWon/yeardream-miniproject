# MongoDB

## 개요

- 프로젝트 내에서 MongoDB는 레플리카셋으로 데이터를 보호하고 Redis Cluster와 연결하여 웹 개발 & 운영 부서에서 사용하게 됩니다.
- 웹 개발에 이용되는 데이터가 대부분 비정형 데이터기때문에 NoSQL db인 mongodb와 redis를 서로 상호보완적인 관계로 구축하였고 영구 저장이 필요한 데이터는 mongodb 레플리카셋에 저장되여 redis클러스터엔 로그인 세션 같은 사용이 많고 짧은 시간 사용되는 데이터를 캐싱하여 처리합니다.


### 주요 구성 요소:
1. **StatefulSet**:
   - MongoDB 인스턴스를 복제하여 다중 인스턴스를 운영합니다. `replicas: 2`로 2개의 MongoDB 인스턴스가 생성됩니다.
   - 각 MongoDB 인스턴스는 고유한 PVC를 사용하여 데이터를 영구적으로 저장합니다.

2. **ReplicaSet 설정**:
   - MongoDB가 **ReplicaSet**으로 설정되어, 고가용성과 데이터 복제를 지원합니다. 이 구성은 리더 선출 및 데이터 일관성을 보장합니다.

    - Primary 노드는 단일:

        - **ReplicaSet**에서 Primary 노드는 항상 하나입니다. Primary 노드는 **쓰기 작업**을 처리하고, 모든 쓰기 작업은 Primary 노드에 먼저 적용된 후, Secondary 노드들로 복제됩니다.

    - Secondary 노드가 증가:

        - 레플리카 개수를 늘리면 **Secondary 노드**가 추가됩니다. Secondary 노드는 Primary 노드의 데이터를 복제하며, **읽기 작업**에 사용될 수 있습니다.
        - 따라서, 레플리카 개수를 늘리는 것은 **읽기 성능을 확장**하는 데 유용합니다. 클러스터에 더 많은 Secondary 노드가 생기면, 여러 Secondary 노드로 **읽기 요청을 분산**시킬 수 있기 때문입니다.

### Primary 노드 장애 시 리더 선출:

- Primary 노드가 장애를 일으킬 경우, ReplicaSet 내에서 남아 있는 Secondary 노드들 중 하나가 **새로운 Primary 노드**로 선출됩니다. 이를 통해 **고가용성**을 유지할 수 있습니다.


3. **Headless Service**:
   - **Headless Service**는 각 Pod에 고유한 DNS 이름을 부여하여 Pod 간 통신을 가능하게 하고, MongoDB 인스턴스 간 데이터 복제를 지원합니다.

4. **Persistent Volume (EFS)**:
   - **Amazon EFS**와 같은 네트워크 파일 시스템을 사용하여 PVC를 마운트하고, 데이터를 영구적으로 저장하여 데이터 영속성을 보장합니다.

### 장단점

#### 현재 구성의 장점:

1. **고가용성 및 데이터 복제**:
   - **ReplicaSet**을 사용하여 MongoDB 데이터를 여러 인스턴스 간에 복제합니다. 하나의 인스턴스에 장애가 발생하더라도 다른 인스턴스가 데이터를 유지하고 서비스를 지속할 수 있습니다.
   - 장애 발생 시, **리더 선출**이 자동으로 이루어져 클러스터의 연속성을 보장합니다.

2. **데이터 영속성**:
   - 각 인스턴스가 고유한 **Persistent Volume**을 사용하므로, MongoDB 인스턴스가 재시작되거나 재배포되더라도 데이터 손실이 발생하지 않습니다.
   - **EFS** 같은 네트워크 스토리지를 사용하여 **고가용성 스토리지**를 제공하고, 여러 인스턴스 간에 데이터를 안전하게 공유할 수 있습니다.

3. **확장성**:
   - **StatefulSet**을 사용하면 **수평 확장**이 가능하여, MongoDB 인스턴스를 더 추가하여 확장할 수 있습니다. 이를 통해 **읽기/쓰기 성능**을 개선할 수 있습니다.

4. **보안**:
   - **SCRAM-SHA-1 인증 메커니즘**을 통해 보안을 강화하고 있습니다. 이는 MongoDB의 표준 인증 방식으로, 안전한 사용자 인증을 보장합니다.

---

#### 현재 구성의 단점:

1. **복잡한 설정**:
   - **ReplicaSet** 구성은 일반적인 단일 노드 MongoDB 구성보다 복잡합니다. 데이터 복제, 리더 선출, 네트워크 설정 등 여러 구성 요소를 관리해야 합니다.

2. **헤드리스 서비스로 인한 네트워크 복잡성**:
   - **Headless Service**를 사용하여 각 MongoDB 인스턴스가 고유한 DNS 이름을 갖게 하므로, 네트워크와 연결성 관리가 추가로 필요합니다.

3. **EFS의 성능**:
   - **EFS**와 같은 네트워크 파일 시스템은 **랜덤 읽기/쓰기 성능**이 상대적으로 떨어질 수 있습니다. 따라서 매우 높은 I/O가 필요한 MongoDB 워크로드에서는 성능 문제가 발생할 수 있습니다.


---

## 다른 MongoDB 구성 방식

### 1. 단일 노드 MongoDB 구성

MongoDB 인스턴스를 하나만 배포하여 복제 없이 운영하는 방식입니다.

#### 장점:
- **구성 간단**: 단일 인스턴스이므로 관리가 간편.
- **성능 우수**: 복제가 없으므로 쓰기 성능이 향상될 수 있음.
- **저렴한 비용**: 복제 및 추가 인스턴스가 없으므로 비용 절감.

#### 단점:
- **데이터 손실 위험**: 장애 발생 시 데이터 손실 가능성.
- **고가용성 없음**: 단일 인스턴스 장애 시 서비스가 중단됨.

---

### 2. Sharded Cluster (샤드 클러스터)

데이터를 여러 샤드로 분리하여 분산 저장하는 방식입니다.
저희 팀은 Redis 클러스터를 통해 분산방식을 구현 해봄으로 대체하였습니다.

#### 장점:
- **확장성 극대화**: 매우 큰 데이터 세트 및 대규모 트래픽 처리 가능.
- **성능 향상**: 데이터를 분산하여 읽기/쓰기 성능 향상.
- **데이터 균등 분배**: 샤드를 통해 부하 분산 가능.

#### 단점:
- **복잡한 구성**: 관리 및 설정이 매우 복잡.
- **쿼리 처리 복잡성**: 샤딩된 데이터에 대한 복잡한 쿼리는 성능 저하 발생 가능.
- **높은 운영 비용**: 여러 샤드를 운영하므로 비용 증가.

---

### 3. ReplicaSet + Arbiter 구성

ReplicaSet에 **Arbiter** 노드를 추가하여, 데이터 복제본 없이 리더 선출 메커니즘을 보강하는 방식입니다.

#### 장점:
- **저렴한 고가용성**: Arbiter는 데이터를 저장하지 않으므로 적은 리소스로 고가용성 확보 가능.
- **복제본 관리 최소화**: Arbiter는 데이터 저장 없이 리더 선출만 돕기 때문에 관리 부담이 적음.

#### 단점:
- **데이터 일관성 문제**: Arbiter는 데이터 복제를 하지 않으므로 복제본 수가 적을 경우 데이터 일관성 문제 발생 가능.
- **보안 문제**: Arbiter는 네트워크를 통해 리더 선출에 관여하므로 네트워크 보안 관리가 필요.

---

## 결론

MongoDB의 구성 방식은 사용 목적에 따라 달라집니다. 현재 구성된 **StatefulSet과 ReplicaSet 기반의 MongoDB**는 고가용성과 데이터 복제를 제공하며 데이터 영속성을 보장하는 좋은 방법입니다. 하지만 성능 최적화나 비용 절감을 위해 **Sharding** 또는 **단일 노드 MongoDB** 구성을 선택할 수 있으며, **Arbiter**를 통해 리더 선출 메커니즘을 보강할 수 있습니다.




---

- Document 지향 NoSQL 데이터베이스로 JSON형식의 직렬화 형태인 BSON을 사용하여 속도증가와 RPC(원격 프로시저 호출)이 용이함
> 원격 프로시저 호출: 다른 시스템의 포로시저(함수)를 호출할 수 있게 해주는 프로토콜, 분산 시스템에서 시스템 간의 상호 작용을 위해 자주 사용됨.

---

- cluster 구성 이슈
mongodb는 클러스터를 레플리카셋으로 제공? https://www.mongodb.com/resources/products/compatibilities/deploying-a-mongodb-cluster-with-docker
레플리카셋과 클러스터를 혼용하여 사용함(개인적인 이해 이슈일 수 있음)
docker image도 community와 enterprise로 나뉘고, 클라우드 서비스를 유료로 제공

- Docker image를 이용한 k8s replica
pod간 연결을 위한 서비스 mongodb-svc.yaml
pv, pvc, statefulset 설정 mongodb-statefulset.yaml
pod안 mongodb에 명령어를 전달하기 위한 mongodb-cronjob.yaml

- 파드안 몽고디비에 명령어 전달 자동화를 위한 시도

-- initContainers option
pod생성후 mongodb가 띄워진 상태에서 커맨드를 보내야 되는데 파드 생성단계에서 커맨드를 보내니 오류가 발생함
파드가 init 상태에 걸려있는 오류 확인

-- lifecycle.postStart option
mongodb가 띄워지는 시간을 주기 위해 sleep을 걸면 pod에 sleep이 걸림

-- k8s cronjob
스케줄링을 통해 해결되는 듯 했으나 12일자 cronjob이 먼저돌고 pod가 생성되면 pod에 문제가 생기는 것을 확인, 수정중
mongodb-0이 커맨드를 받는 pod인데 crashloopback 상태에 빠짐


---
### 클러스터구성시엔   volumeClaimTemplates: 옵션을 사용해야함

